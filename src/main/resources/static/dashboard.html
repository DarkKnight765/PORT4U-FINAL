<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PORT4U Dashboard</title>
  <link rel="stylesheet" href="assets/styles/dashboard.css"/>
  <style>
    body { font-family: sans-serif; padding:1em; background:#f7f1e7; }
    header { display:flex; justify-content:space-between; align-items:center; }
    table { width:100%; border-collapse:collapse; margin-bottom:1em; }
    th,td { border:1px solid #ccc; padding:0.5em; }
    th { background:#eee; }
    .hidden { display:none; }
    .loading { color:#888; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Dashboard</h1>
    <button id="out">Log out</button>
  </header>

  <!-- Admin -->
  <section id="adminSec" class="hidden">
    <h2>Pending Portfolios</h2>
    <table id="ptab">
      <thead><tr><th>ID</th><th>Title</th><th>Author</th><th>Created At</th><th>Actions</th></tr></thead>
      <tbody><tr><td colspan="5" class="loading">Loading…</td></tr></tbody>
    </table>

    <h2>All Users</h2>
    <ul id="ulist"><li class="loading">Loading…</li></ul>
  </section>

  <!-- Client -->
  <section id="clientSec" class="hidden">
    <h2>Your Purchased Portfolios</h2>
    <table id="ctab1">
      <thead><tr><th>ID</th><th>Title</th><th>Author</th><th>Status</th><th>Purchased On</th></tr></thead>
      <tbody><tr><td colspan="5" class="loading">Loading…</td></tr></tbody>
    </table>

    <h2>Recommended For You</h2>
    <table id="ctab2">
      <thead><tr><th>ID</th><th>Title</th><th>Author</th><th>Status</th><th>Recommended On</th></tr></thead>
      <tbody><tr><td colspan="5" class="loading">Loading…</td></tr></tbody>
    </table>
  </section>

  <script>
    // — Auth check
    const basic = localStorage.getItem('PORT4U_BASIC'),
          usr   = JSON.parse(localStorage.getItem('PORT4U_USER')||'{}');
    if(!basic||!usr.username){
      return location.href='login.html';
    }
    const hdrs = { 'Authorization':'Basic '+basic,'Content-Type':'application/json' };
    const isAdmin = usr.role==='ADMIN';
    document.getElementById('title').textContent = isAdmin? 'Admin Dashboard':'Client Dashboard';
    document.getElementById(isAdmin?'adminSec':'clientSec').classList.remove('hidden');

    // — Logout
    document.getElementById('out').onclick = ()=>{
      localStorage.clear();
      location.href='login.html';
    };

    // — API helper
    async function load(path, onData){
      try {
        const res = await fetch('http://localhost:8081'+path,{headers:hdrs});
        if(res.status===401) throw new Error('unauthorized');
        const data = await res.json();
        onData(data);
      } catch(e){
        console.warn(path,e);
        if(e.message==='unauthorized') return location.href='login.html';
      }
    }

    if(isAdmin){
      // pending
      load('/api/admin/portfolios/pending', list=>{
        const b=document.querySelector('#ptab tbody');
        b.innerHTML = '';
        list.forEach(p=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${p.id}</td>
            <td>${p.title}</td>
            <td>${p.author}</td>
            <td>${new Date(p.createdAt).toLocaleString()}</td>
            <td>
              <button onclick="alert('Approve')">Approve</button>
              <button onclick="alert('Reject')">Reject</button>
            </td>`;
          b.append(tr);
        });
      });
      // users
      load('/api/admin/users', list=>{
        const u=document.getElementById('ulist'); u.innerHTML='';
        list.forEach(n=>{
          const li=document.createElement('li'); li.textContent=n;
          u.append(li);
        });
      });

    } else {
      // purchased
      load('/api/client/portfolios/purchased', list=>{
        const b=document.querySelector('#ctab1 tbody'); b.innerHTML='';
        list.forEach(p=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${p.id}</td><td>${p.title}</td>
            <td>${p.author}</td><td>${p.status}</td>
            <td>${new Date(p.purchasedOn||p.createdOn||Date.now()).toLocaleString()}</td>`;
          b.append(tr);
        });
      });
      // recommended
      load('/api/client/portfolios/recommended', list=>{
        const b=document.querySelector('#ctab2 tbody'); b.innerHTML='';
        list.forEach(p=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${p.id}</td><td>${p.title}</td>
            <td>${p.author}</td><td>${p.status}</td>
            <td>${new Date(p.recommendedOn||Date.now()).toLocaleString()}</td>`;
          b.append(tr);
        });
      });
    }
  </script>
</body>
</html>
